<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>URL Rewriting Middleware in ASP.NET Core | Microsoft Docs </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="URL Rewriting Middleware in ASP.NET Core | Microsoft Docs ">
    <meta name="generator" content="docfx 2.22.2.0">
    
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <meta property="docfx:navrel" content="/foo">
    <meta property="docfx:tocrel" content="../toc.html">
    
    
  </head>
  <body data-spy="scroll" data-target="#affix">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">切换导航</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">显示 / 隐藏目录</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="fundamentals/url-rewriting">
<h1 id="url-rewriting-middleware-in-aspnet-core">URL Rewriting Middleware in ASP.NET Core</h1>

<p>By <a href="https://github.com/GuardRex">Luke Latham</a> and <a href="https://github.com/mikaelm12">Mikael Mengistu</a></p>
<p><a href="https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/url-rewriting/sample">View or download sample code</a></p>
<p>URL rewriting is the act of modifying request URLs based on one or more predefined rules. URL rewriting creates an abstraction between resource locations and their addresses so that the locations and addresses are not tightly linked. There are several scenarios where URL rewriting is valuable:</p>
<ul>
<li>Moving or replacing server resources temporarily or permanently while maintaining stable locators for those resources</li>
<li>Splitting request processing across different applications or across areas of one application</li>
<li>Removing, adding, or reorganizing URL segments on incoming requests</li>
<li>Optimizing public URLs for Search Engine Optimization (SEO)</li>
<li>Permitting the use of friendly public URLs to help people predict the content they will find by following a link</li>
<li>Redirecting insecure requests to secure endpoints</li>
<li>Preventing image hotlinking</li>
</ul>
<p>You can define rules for changing the URL in several ways, including regular expression (regex) matching rules, rules based on the Apache mod_rewrite module, rules based on the IIS Rewrite Module, and with your own method and class rule logic. This document introduces URL rewriting with instructions on how to use URL Rewriting Middleware in ASP.NET Core applications.</p>
<div class="NOTE"><h5>备注</h5><p>URL rewriting can reduce the performance of an application. Where feasible, you should limit the number and complexity of rules.</p>
</div>
<h2 id="url-redirect-and-url-rewrite">URL redirect and URL rewrite</h2>
<p>The difference in wording between <em>URL redirect</em> and <em>URL rewrite</em> may seem subtle at first but has important implications for providing resources to clients. ASP.NET Core&#39;s URL Rewriting Middleware is capable of meeting the need for both.</p>
<p>A <em>URL redirect</em> is a client-side operation, where the client is instructed to access a resource at another address. This requires a round-trip to the server, and the redirect URL returned to the client will appear in the browser&#39;s address bar when the client makes a new request for the resource. If <code>/resource</code> is <em>redirected</em> to <code>/different-resource</code>, the client will request <code>/resource</code>, and the server will respond that the client should obtain the resource at <code>/different-resource</code> with a status code indicating that the redirect is either temporary or permanent. The client will execute a new request for the resource at the redirect URL.</p>
<p><img src="url-rewriting/static/url_redirect.png" alt="A WebAPI service endpoint has been temporarily changed from version 1 (v1) to version 2 (v2) on the server. A client makes a request to the service at the version 1 path /v1/api. The server sends back a 302 (Found) response with the new, temporary path for the service at version 2 /v2/api. The client makes a second request to the service at the redirect URL. The server responds with a 200 (OK) status code."></p>
<p>When redirecting requests to a different URL, you will indicate whether the redirect is permanent or temporary. The 301 (Moved Permanently) status code is used where the resource has a new, permanent URL and you wish to instruct the client that all future requests for the resource should use the new URL. The client will cache the response when a 301 status code is received. The 302 (Found) status code is used where the redirection is temporary or generally subject to change, such that the client should not store and reuse the redirect URL in the future. For more information, see <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html">RFC 2616: Status Code Definitions</a>.</p>
<p>A <em>URL rewrite</em> is a server-side operation to provide a resource from a different resource address. Rewriting a URL doesn&#39;t require a round-trip to the server. The rewritten URL is not returned to the client and won&#39;t appear in a browser&#39;s address bar. When <code>/resource</code> is <em>rewritten</em> to <code>/different-resource</code>, the client will request <code>/resource</code>, and the server will <em>internally</em> fetch the resource at <code>/different-resource</code>. Although the client might be able to retrieve the resource at the rewritten URL, the client won&#39;t be informed that the resource exists at the rewritten URL when it makes its request and receives the response.</p>
<p><img src="url-rewriting/static/url_rewrite.png" alt="A WebAPI service endpoint has been changed from version 1 (v1) to version 2 (v2) on the server. A client makes a request to the service at the version 1 path /v1/api. The request URL is rewritten to access the service at the version 2 path /v2/api. The service responds to the client with a 200 (OK) status code."></p>
<h2 id="url-rewriting-sample-application">URL rewriting sample application</h2>
<p>You can explore the features of the URL Rewriting Middleware with the <a href="https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/url-rewriting/sample">URL rewriting sample application</a>. The application applies rewrite and redirect rules and shows the resultant rewritten or redirected URL.</p>
<h2 id="when-to-use-url-rewriting-middleware">When to use URL Rewriting Middleware</h2>
<p>Use URL Rewriting Middleware when you are unable to use the <a href="https://www.iis.net/downloads/microsoft/url-rewrite">URL Rewrite module</a> in IIS on Windows Server, the <a href="https://httpd.apache.org/docs/2.4/rewrite/">Apache mod_rewrite module</a> on Apache Server, <a href="https://www.nginx.com/blog/creating-nginx-rewrite-rules/">URL rewriting on Nginx</a>, or your application is hosted on <a class="xref" href="servers/weblistener.html">WebListener server</a>. The main reasons to use the server-based URL rewriting technologies in IIS, Apache, or Nginx are that the middleware doesn&#39;t support the full features of these modules and the performance of the middleware probably won&#39;t match that of the modules. However, there are some features of the server modules that don&#39;t work with ASP.NET Core projects, such as the <code>IsFile</code> and <code>IsDirectory</code> constraints of the IIS Rewrite module. In these scenarios, you can use the middleware instead.</p>
<h2 id="package">Package</h2>
<p>To include the middleware in your project, add a reference to the  <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Rewrite/"><code>Microsoft.AspNetCore.Rewrite</code></a> package. The middleware depends on .NET Framework 4.5.1 or .NET Standard 1.3 or later. This feature is available for apps that target ASP.NET Core 1.1.0 or later.</p>
<h2 id="extension-and-options">Extension and options</h2>
<p>Establish your URL rewrite and redirect rules by creating an instance of the <code>RewriteOptions</code> class with extension methods for each of your rules. Chain multiple rules in the order that you would like them processed. The <code>RewriteOptions</code> are passed into the URL Rewriting Middleware as it&#39;s added to the request pipeline with <code>app.UseRewriter(options);</code>.</p>
<pre><code class="lang-csharp" name="Main">var options = new RewriteOptions()
    .AddRedirect(&quot;redirect-rule/(.*)&quot;, &quot;redirected/$1&quot;)
    .AddRewrite(@&quot;^rewrite-rule/(\d+)/(\d+)&quot;, &quot;rewritten?var1=$1&amp;var2=$2&quot;, skipRemainingRules: true)
    .AddApacheModRewrite(env.ContentRootFileProvider, &quot;ApacheModRewrite.txt&quot;)
    .AddIISUrlRewrite(env.ContentRootFileProvider, &quot;IISUrlRewrite.xml&quot;)
    .Add(RedirectXMLRequests)
    .Add(new RedirectImageRequests(&quot;.png&quot;, &quot;/png-images&quot;))
    .Add(new RedirectImageRequests(&quot;.jpg&quot;, &quot;/jpg-images&quot;));

app.UseRewriter(options);
</code></pre><h3 id="url-redirect">URL redirect</h3>
<p>Use <code>AddRedirect()</code> to redirect requests. The first parameter will contain your regex for matching on the path of the incoming URL. The second parameter is the replacement string. The third parameter, if present, specifies the status code. If you don&#39;t specify the status code, it defaults to 302 (Found), which indicates that the resource has been temporarily moved or replaced.</p>
<pre><code class="lang-csharp" name="Main" highlight-lines="2">var options = new RewriteOptions()
    .AddRedirect(&quot;redirect-rule/(.*)&quot;, &quot;redirected/$1&quot;)
    .AddRewrite(@&quot;^rewrite-rule/(\d+)/(\d+)&quot;, &quot;rewritten?var1=$1&amp;var2=$2&quot;, skipRemainingRules: true)
    .AddApacheModRewrite(env.ContentRootFileProvider, &quot;ApacheModRewrite.txt&quot;)
    .AddIISUrlRewrite(env.ContentRootFileProvider, &quot;IISUrlRewrite.xml&quot;)
    .Add(RedirectXMLRequests)
    .Add(new RedirectImageRequests(&quot;.png&quot;, &quot;/png-images&quot;))
    .Add(new RedirectImageRequests(&quot;.jpg&quot;, &quot;/jpg-images&quot;));

app.UseRewriter(options);
</code></pre><p>In a browser with developer tools enabled, make a request to the sample application with the path <code>/redirect-rule/1234/5678</code>. The regex matches the request path on <code>redirect-rule/(.*)</code>, and the path is replaced with <code>/redirected/1234/5678</code>. The redirect URL is sent back to the client with a 302 (Found) status code. The browser makes a new request at the redirect URL, which will appear in the browser&#39;s address bar. Since no rules in the sample application match on the redirect URL, the second request receives a 200 (OK) response from the application and the body of the response shows the redirect URL. A complete roundtrip is made to the server when a URL is <em>redirected</em>.</p>
<p>Original Request: <code>/redirect-rule/1234/5678</code></p>
<p><img src="url-rewriting/static/add_redirect.png" alt="Browser window with Developer Tools tracking the requests and responses"></p>
<p>The part of the expression contained by parentheses is called a <em>capture group</em>. The dot (<code>.</code>) of the expression means <em>match any character</em>, and the asterisk (<code>*</code>) signifies to <em>match the preceding character zero or more times</em>. Therefore, the last two path segments of the URL, <code>1234/5678</code>, are captured by capture group <code>(.*)</code>. Any value you provide in the request URL after <code>redirect-rule/</code> will be captured by this single capture group.</p>
<p>In the replacement string, captured groups are injected into the string with the dollar sign (<code>$</code>) followed by the sequence number of the capture. The first capture group value is obtained with <code>$1</code>, the second with <code>$2</code>, and they continue in sequence for the capture groups in your regex. There is only one captured group in the redirect rule regex in the sample application, so there is only one injected group in the replacement string, which is <code>$1</code>. When the rule is applied, the URL becomes <code>/redirected/1234/5678</code>.</p>
<h3 id="url-redirect-to-a-secure-endpoint">URL redirect to a secure endpoint</h3>
<p>Use <code>AddRedirectToHttps()</code> to redirect insecure requests to the same host and path with secure HTTPS protocol (<code>https://</code>) with the flexibility to choose the status code and port. If the status code is not supplied, the middleware will default to 302 (Found). If the port is not supplied, the middleware will default to <code>null</code>, which means the protocol will change to <code>https://</code> and the client will access the resource on port 443. The example shows how to set the status code to 301 (Moved Permanently) and change the port to 5001.</p>
<pre><code class="lang-csharp">var options = new RewriteOptions()
    .AddRedirectToHttps(301, 5001);

app.UseRewriter(options);
</code></pre><p>Use <code>AddRedirectToHttpsPermanent()</code> to redirect insecure requests to the same host and path with secure HTTPS protocol (<code>https://</code> on port 443). The middleware will set the status code to 301 (Moved Permanently).</p>
<p>The sample application is capable of demonstrating how to use <code>AddRedirectToHttps()</code> or <code>AddRedirectToHttpsPermanent()</code>. Add the extension method to the <code>RewriteOptions()</code>. Make an insecure request to the application at any URL. In order to see the response in a browser, you will probably need to dismiss a browser security warning that the self-signed certificate is untrusted.</p>
<p>Original Request using <code>AddRedirectToHttps(301, 5001)</code>: <code>/secure</code></p>
<p><img src="url-rewriting/static/add_redirect_to_https.png" alt="Browser window with Developer Tools tracking the requests and responses"></p>
<p>Original Request using <code>AddRedirectToHttpsPermanent()</code>: <code>/secure</code></p>
<p><img src="url-rewriting/static/add_redirect_to_https_permanent.png" alt="Browser window with Developer Tools tracking the requests and responses"></p>
<h3 id="url-rewrite">URL rewrite</h3>
<p>Use <code>AddRewrite()</code> to create a rules for rewriting URLs. The first parameter will contain your regex for matching on the incoming URL path. The second parameter is the replacement string. The third parameter, <code>skipRemainingRules: {true|false}</code>, will indicate to the middleware whether or not to skip additional rewrite rules if the current rule is applied.</p>
<pre><code class="lang-csharp" name="Main" highlight-lines="3">var options = new RewriteOptions()
    .AddRedirect(&quot;redirect-rule/(.*)&quot;, &quot;redirected/$1&quot;)
    .AddRewrite(@&quot;^rewrite-rule/(\d+)/(\d+)&quot;, &quot;rewritten?var1=$1&amp;var2=$2&quot;, skipRemainingRules: true)
    .AddApacheModRewrite(env.ContentRootFileProvider, &quot;ApacheModRewrite.txt&quot;)
    .AddIISUrlRewrite(env.ContentRootFileProvider, &quot;IISUrlRewrite.xml&quot;)
    .Add(RedirectXMLRequests)
    .Add(new RedirectImageRequests(&quot;.png&quot;, &quot;/png-images&quot;))
    .Add(new RedirectImageRequests(&quot;.jpg&quot;, &quot;/jpg-images&quot;));

app.UseRewriter(options);
</code></pre><p>Original Request: <code>/rewrite-rule/1234/5678</code></p>
<p><img src="url-rewriting/static/add_rewrite.png" alt="Browser window with Developer Tools tracking the request and response"></p>
<p>The first thing you will notice in the regex is the carat (<code>^</code>) at the beginning of the expression. This means that matching should be attempted starting at the beginning of the URL path.</p>
<p>In the earlier example with the redirect rule, <code>redirect-rule/(.*)</code>, there is no carat at the start of the regex; therefore, any characters may precede <code>redirect-rule/</code> in the path for a successful match.</p>
<table>
<thead>
<tr>
<th>Path</th>
<th style="text-align:center">Match</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/redirect-rule/1234/5678</code></td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td><code>/my-cool-redirect-rule/1234/5678</code></td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td><code>/anotherredirect-rule/1234/5678</code></td>
<td style="text-align:center">Yes</td>
</tr>
</tbody>
</table>
<p>The rewrite rule, <code>^rewrite-rule/(\d+)/(\d+)</code>, will only match paths if they start with <code>rewrite-rule/</code>. Notice the difference in matching between the rewrite rule below and the redirect rule above.</p>
<table>
<thead>
<tr>
<th>Path</th>
<th style="text-align:center">Match</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/rewrite-rule/1234/5678</code></td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td><code>/my-cool-rewrite-rule/1234/5678</code></td>
<td style="text-align:center">No</td>
</tr>
<tr>
<td><code>/anotherrewrite-rule/1234/5678</code></td>
<td style="text-align:center">No</td>
</tr>
</tbody>
</table>
<p>Following the <code>^rewrite-rule/</code> portion of the expression, there are two capture groups, <code>(\d+)/(\d+)</code>. The <code>\d</code> signifies <em>match a digit (number)</em>. The plus sign (<code>+</code>) means <em>match one or more of the preceding character</em>. Therefore, the URL must contain a number followed by a forward-slash followed by another number. These capture groups are injected into the resultant rewritten URL as <code>$1</code> and <code>$2</code>. The rewrite rule replacement string places the captured groups into the querystring. The requested path of <code>/rewrite-rule/1234/5678</code> is rewritten to obtain the resource at <code>/rewritten?var1=1234&amp;var2=5678</code>. If a querystring is present on the original request, it&#39;s preserved when the URL is rewritten.</p>
<p>There is no roundtrip to the server to obtain the resource. If the resource exists, it&#39;s fetched and returned to the client with a 200 (OK) status code. Because the client isn&#39;t redirected, the URL in the browser address bar doesn&#39;t change. As far as the client is concerned, the URL rewrite operation never occurred.</p>
<div class="NOTE"><h5>备注</h5><p><code>skipRemainingRules: true</code> should be used whenever possible, because matching rules is an expensive process and slows down application response time. For the fastest application response, order your rewrite rules from most frequently matched to least frequently matched and skip the processing of the remaining rules when a match occurs and no additional rule processing is required.</p>
</div>
<h3 id="apache-modrewrite">Apache mod_rewrite</h3>
<p>You can apply Apache mod_rewrite rules with <code>AddApacheModRewrite()</code>. The first parameter takes an <code>IFileProvider</code>, which is provided in the sample application via <a href="dependency-injection.html">Dependency Injection</a> by injecting the <code>IHostingEnvironment</code> and using it to provide the <code>ContentRootFileProvider</code>. The second parameter is the path to your rules file, which is <em>ApacheModRewrite.txt</em> in the sample application. You must make sure that the rules file is deployed with the application. For more information and examples of mod_rewrite rules, see <a href="https://httpd.apache.org/docs/2.4/rewrite/">Apache mod_rewrite</a>.</p>
<pre><code class="lang-csharp" name="Main" highlight-lines="4">var options = new RewriteOptions()
    .AddRedirect(&quot;redirect-rule/(.*)&quot;, &quot;redirected/$1&quot;)
    .AddRewrite(@&quot;^rewrite-rule/(\d+)/(\d+)&quot;, &quot;rewritten?var1=$1&amp;var2=$2&quot;, skipRemainingRules: true)
    .AddApacheModRewrite(env.ContentRootFileProvider, &quot;ApacheModRewrite.txt&quot;)
    .AddIISUrlRewrite(env.ContentRootFileProvider, &quot;IISUrlRewrite.xml&quot;)
    .Add(RedirectXMLRequests)
    .Add(new RedirectImageRequests(&quot;.png&quot;, &quot;/png-images&quot;))
    .Add(new RedirectImageRequests(&quot;.jpg&quot;, &quot;/jpg-images&quot;));

app.UseRewriter(options);
</code></pre><p>The sample application will redirect requests from <code>/apache-mod-rules-redirect/(.\*)</code> to <code>/redirected?id=$1</code>. The response status code is 302 (Found).</p>
<pre><code name="Main"># Rewrite path with additional sub directory
RewriteRule ^/apache-mod-rules-redirect/(.*) /redirected?id=$1 [L,R=302]
</code></pre><p>Original Request: <code>/apache-mod-rules-redirect/1234</code></p>
<p><img src="url-rewriting/static/add_apache_mod_redirect.png" alt="Browser window with Developer Tools tracking the requests and responses"></p>
<h5 id="supported-server-variables">Supported server variables</h5>
<p>The middleware supports the following Apache mod_rewrite server variables:</p>
<ul>
<li>CONN_REMOTE_ADDR</li>
<li>HTTP_ACCEPT</li>
<li>HTTP_CONNECTION</li>
<li>HTTP_COOKIE</li>
<li>HTTP_FORWARDED</li>
<li>HTTP_HOST</li>
<li>HTTP_REFERER</li>
<li>HTTP_USER_AGENT</li>
<li>HTTPS</li>
<li>IPV6</li>
<li>QUERY_STRING</li>
<li>REMOTE_ADDR</li>
<li>REMOTE_PORT</li>
<li>REQUEST_FILENAME</li>
<li>REQUEST_METHOD</li>
<li>REQUEST_SCHEME</li>
<li>REQUEST_URI</li>
<li>SCRIPT_FILENAME</li>
<li>SERVER_ADDR</li>
<li>SERVER_PORT</li>
<li>SERVER_PROTOCOL</li>
<li>TIME</li>
<li>TIME_DAY</li>
<li>TIME_HOUR</li>
<li>TIME_MIN</li>
<li>TIME_MON</li>
<li>TIME_SEC</li>
<li>TIME_WDAY</li>
<li>TIME_YEAR</li>
</ul>
<h3 id="iis-url-rewrite-module-rules">IIS URL Rewrite Module rules</h3>
<p>To use rules that would normally apply to the IIS URL Rewrite Module, use <code>AddIISUrlRewrite()</code>. The first parameter takes an <code>IFileProvider</code>, while the second parameter is the path to your XML rules file, which is <em>IISUrlRewrite.xml</em> in the sample application. You must make sure that the rules file is deployed with the application. Don&#39;t point this at your <em>web.config</em> file, as these rules should be stored outside of your <em>web.config</em> to avoid conflicts with the IIS Rewrite module. For more information and examples of IIS URL Rewrite Module rules, see <a href="https://www.iis.net/learn/extensions/url-rewrite-module/using-url-rewrite-module-20">Using Url Rewrite Module 2.0</a> and <a href="https://www.iis.net/learn/extensions/url-rewrite-module/url-rewrite-module-configuration-reference">URL Rewrite Module Configuration Reference</a>.</p>
<pre><code class="lang-csharp" name="Main" highlight-lines="5">var options = new RewriteOptions()
    .AddRedirect(&quot;redirect-rule/(.*)&quot;, &quot;redirected/$1&quot;)
    .AddRewrite(@&quot;^rewrite-rule/(\d+)/(\d+)&quot;, &quot;rewritten?var1=$1&amp;var2=$2&quot;, skipRemainingRules: true)
    .AddApacheModRewrite(env.ContentRootFileProvider, &quot;ApacheModRewrite.txt&quot;)
    .AddIISUrlRewrite(env.ContentRootFileProvider, &quot;IISUrlRewrite.xml&quot;)
    .Add(RedirectXMLRequests)
    .Add(new RedirectImageRequests(&quot;.png&quot;, &quot;/png-images&quot;))
    .Add(new RedirectImageRequests(&quot;.jpg&quot;, &quot;/jpg-images&quot;));

app.UseRewriter(options);
</code></pre><p>The sample application will rewrite requests from <code>/iis-rules-rewrite/(.*)</code> to <code>/rewritten?id=$1</code>. The response is sent to the client with a 200 (OK) status code.</p>
<pre><code class="lang-xml" name="Main">&lt;rewrite&gt;
  &lt;rules&gt;
    &lt;rule name=&quot;Rewrite segment to id querystring&quot; stopProcessing=&quot;true&quot;&gt;
      &lt;match url=&quot;^iis-rules-rewrite/(.*)$&quot; /&gt;
      &lt;action type=&quot;Rewrite&quot; url=&quot;rewritten?id={R:1}&quot; appendQueryString=&quot;false&quot;/&gt;
    &lt;/rule&gt;
  &lt;/rules&gt;
&lt;/rewrite&gt;
</code></pre><p>Original Request: <code>/iis-rules-rewrite/1234</code></p>
<p><img src="url-rewriting/static/add_iis_url_rewrite.png" alt="Browser window with Developer Tools tracking the request and response"></p>
<p>If you have an active IIS Rewrite Module with server-level rules configured that would impact your application in undesirable ways, you can disable the IIS Rewrite Module for an application. For more information, see <a class="xref" href="../hosting/iis-modules.html#disabling-iis-modules">Disabling IIS modules</a>.</p>
<h4 id="unsupported-features">Unsupported features</h4>
<p>The middleware does not support the following IIS URL Rewrite Module features:</p>
<ul>
<li>Global rules (<a href="https://github.com/aspnet/BasicMiddleware/pull/169">Basic Middleware #169</a>)</li>
<li>Rewrite Maps (<a href="https://github.com/aspnet/BasicMiddleware/pull/168">Basic Middleware #168</a>)</li>
<li>CustomResponse action (<a href="https://github.com/aspnet/BasicMiddleware/issues/135">Basic Middleware #135</a>)</li>
<li>Custom Server Variables (<a href="https://github.com/aspnet/BasicMiddleware/issues/183">Basic Middleware #183</a>)</li>
<li>trackAllCaptures (<a href="https://github.com/aspnet/BasicMiddleware/pull/178">Basic Middleware #178</a>)</li>
<li>Wildcards</li>
<li>LogRewrittenUrl</li>
</ul>
<h4 id="supported-server-variables">Supported server variables</h4>
<p>The middleware supports the following IIS URL Rewrite Module server variables:</p>
<ul>
<li>CONTENT_LENGTH</li>
<li>CONTENT_TYPE</li>
<li>HTTP_ACCEPT</li>
<li>HTTP_CONNECTION</li>
<li>HTTP_COOKIE</li>
<li>HTTP_HOST</li>
<li>HTTP_REFERER</li>
<li>HTTP_URL</li>
<li>HTTP_USER_AGENT</li>
<li>HTTPS</li>
<li>LOCAL_ADDR</li>
<li>QUERY_STRING</li>
<li>REMOTE_ADDR</li>
<li>REMOTE_PORT</li>
<li>REQUEST_FILENAME</li>
<li>REQUEST_URI</li>
</ul>
<div class="NOTE"><h5>备注</h5><p>You can also obtain an <code>IFileProvider</code> via a <code>PhysicalFileProvider</code>. This approach may provide greater flexibility for the location of your rewrite rules files. Make sure that your rewrite rules files are deployed to the server at the path you provide.</p>
<pre><code class="lang-csharp">PhysicalFileProvider fileProvider = new PhysicalFileProvider(Directory.GetCurrentDirectory());
</code></pre></div>
<h3 id="method-based-rule">Method-based rule</h3>
<p>Use <code>Add(Action&lt;RewriteContext&gt; applyRule)</code> to implement your own rule logic in a method. The <code>RewriteContext</code> exposes the <code>HttpContext</code> for use in your method. The <code>context.Result</code> determines how additional pipeline processing is handled.</p>
<table>
<thead>
<tr>
<th><code>context.Result</code></th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>RuleResult.ContinueRules</code> (default)</td>
<td>Continue applying rules</td>
</tr>
<tr>
<td><code>RuleResult.EndResponse</code></td>
<td>Stop applying rules and send the response</td>
</tr>
<tr>
<td><code>RuleResult.SkipRemainingRules</code></td>
<td>Stop applying rules and send the context to the next middleware</td>
</tr>
</tbody>
</table>
<pre><code class="lang-csharp" name="Main" highlight-lines="6">var options = new RewriteOptions()
    .AddRedirect(&quot;redirect-rule/(.*)&quot;, &quot;redirected/$1&quot;)
    .AddRewrite(@&quot;^rewrite-rule/(\d+)/(\d+)&quot;, &quot;rewritten?var1=$1&amp;var2=$2&quot;, skipRemainingRules: true)
    .AddApacheModRewrite(env.ContentRootFileProvider, &quot;ApacheModRewrite.txt&quot;)
    .AddIISUrlRewrite(env.ContentRootFileProvider, &quot;IISUrlRewrite.xml&quot;)
    .Add(RedirectXMLRequests)
    .Add(new RedirectImageRequests(&quot;.png&quot;, &quot;/png-images&quot;))
    .Add(new RedirectImageRequests(&quot;.jpg&quot;, &quot;/jpg-images&quot;));

app.UseRewriter(options);
</code></pre><p>The sample application demonstrates a method that redirects requests for paths that end with <code>.xml</code>. If you make a request for <code>/file.xml</code>, it&#39;s redirected to <code>/xmlfiles/file.xml</code>. The status code is set to 301 (Moved Permanently). For a redirect, you must explicitly set the status code of the response; otherwise, a 200 (OK) status code will be returned and the redirect won&#39;t occur on the client.</p>
<pre><code class="lang-csharp" name="Main">static void RedirectXMLRequests(RewriteContext context)
{
    var request = context.HttpContext.Request;

    // Because we&#39;re redirecting back to the same app, stop processing if the request has already been redirected
    if (request.Path.StartsWithSegments(new PathString(&quot;/xmlfiles&quot;)))
    {
        return;
    }

    if (request.Path.Value.EndsWith(&quot;.xml&quot;, StringComparison.OrdinalIgnoreCase))
    {
        var response = context.HttpContext.Response;
        response.StatusCode = StatusCodes.Status301MovedPermanently;
        context.Result = RuleResult.EndResponse;
        response.Headers[HeaderNames.Location] = &quot;/xmlfiles&quot; + request.Path + request.QueryString;
    }
}
</code></pre><p>Original Request: <code>/file.xml</code></p>
<p><img src="url-rewriting/static/add_redirect_xml_requests.png" alt="Browser window with Developer Tools tracking the requests and responses for file.xml"></p>
<h3 id="irule-based-rule">IRule-based rule</h3>
<p>Use <code>Add(IRule)</code> to implement your own rule logic in a class that derives from <code>IRule</code>. Using an <code>IRule</code> provides greater flexibility over using the method-based rule approach. Your derived class may include a constructor, where you can pass in parameters for the <code>ApplyRule</code> method.</p>
<pre><code class="lang-csharp" name="Main" highlight-lines="7-8">var options = new RewriteOptions()
    .AddRedirect(&quot;redirect-rule/(.*)&quot;, &quot;redirected/$1&quot;)
    .AddRewrite(@&quot;^rewrite-rule/(\d+)/(\d+)&quot;, &quot;rewritten?var1=$1&amp;var2=$2&quot;, skipRemainingRules: true)
    .AddApacheModRewrite(env.ContentRootFileProvider, &quot;ApacheModRewrite.txt&quot;)
    .AddIISUrlRewrite(env.ContentRootFileProvider, &quot;IISUrlRewrite.xml&quot;)
    .Add(RedirectXMLRequests)
    .Add(new RedirectImageRequests(&quot;.png&quot;, &quot;/png-images&quot;))
    .Add(new RedirectImageRequests(&quot;.jpg&quot;, &quot;/jpg-images&quot;));

app.UseRewriter(options);
</code></pre><p>The values of the parameters in the sample application for the <code>extension</code> and the <code>newPath</code> are checked to meet several conditions. The <code>extension</code> must contain a value, and the value must be <em>.png</em>, <em>.jpg</em>, or <em>.gif</em>. If the <code>newPath</code> isn&#39;t valid, an <code>ArgumentException</code> is thrown. If you make a request for <em>image.png</em>, it&#39;s redirected to <code>/png-images/image.png</code>. If you make a request for <em>image.jpg</em>, it&#39;s redirected to <code>/jpg-images/image.jpg</code>. The status code is set to 301 (Moved Permanently), and the <code>context.Result</code> is set to stop processing rules and send the response.</p>
<pre><code class="lang-csharp" name="Main">public class RedirectImageRequests : IRule
{
    private readonly string _extension;
    private readonly PathString _newPath;

    public RedirectImageRequests(string extension, string newPath)
    {
        if (string.IsNullOrEmpty(extension))
        {
            throw new ArgumentException(nameof(extension));
        }

        if (!Regex.IsMatch(extension, @&quot;^\.(png|jpg|gif)$&quot;))
        {
            throw new ArgumentException(&quot;The extension is not valid. The extension must be .png, .jpg, or .gif.&quot;, nameof(extension));
        }

        if (!Regex.IsMatch(newPath, @&quot;(/[A-Za-z0-9]+)+?&quot;))
        {
            throw new ArgumentException(&quot;The path is not valid. Provide an alphanumeric path that starts with a forward slash.&quot;, nameof(newPath));
        }

        _extension = extension;
        _newPath = new PathString(newPath);
    }

    public void ApplyRule(RewriteContext context)
    {
        var request = context.HttpContext.Request;

        // Because we&#39;re redirecting back to the same app, stop processing if the request has already been redirected
        if (request.Path.StartsWithSegments(new PathString(_newPath)))
        {
            return;
        }

        if (request.Path.Value.EndsWith(_extension, StringComparison.OrdinalIgnoreCase))
        {
            var response = context.HttpContext.Response;
            response.StatusCode = StatusCodes.Status301MovedPermanently;
            context.Result = RuleResult.EndResponse;
            response.Headers[HeaderNames.Location] = _newPath + request.Path + request.QueryString;
        }
    }
}
</code></pre><p>Original Request: <code>/image.png</code></p>
<p><img src="url-rewriting/static/add_redirect_png_requests.png" alt="Browser window with Developer Tools tracking the requests and responses for image.png"></p>
<p>Original Request: <code>/image.jpg</code></p>
<p><img src="url-rewriting/static/add_redirect_jpg_requests.png" alt="Browser window with Developer Tools tracking the requests and responses for image.jpg"></p>
<h2 id="regex-examples">Regex examples</h2>
<table>
<thead>
<tr>
<th>Goal</th>
<th style="text-align:center">Regex String &amp;<br>Match Example</th>
<th style="text-align:center">Replacement String &amp;<br>Output Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Rewrite path into querystring</td>
<td style="text-align:center"><code>^path/(.*)/(.*)</code><br><code>/path/abc/123</code></td>
<td style="text-align:center"><code>path?var1=$1&amp;var2=$2</code><br><code>/path?var1=abc&amp;var2=123</code></td>
</tr>
<tr>
<td>Strip trailing slash</td>
<td style="text-align:center"><code>(.*)/$</code><br><code>/path/</code></td>
<td style="text-align:center"><code>$1</code><br><code>/path</code></td>
</tr>
<tr>
<td>Enforce trailing slash</td>
<td style="text-align:center"><code>(.*[^/])$</code><br><code>/path</code></td>
<td style="text-align:center"><code>$1/</code><br><code>/path/</code></td>
</tr>
<tr>
<td>Avoid rewriting specific requests</td>
<td style="text-align:center"><code>(.*[^(\.axd)])$</code><br>Yes: <code>/resource.htm</code><br>No: <code>/resource.axd</code></td>
<td style="text-align:center"><code>rewritten/$1</code><br><code>/rewritten/resource.htm</code><br><code>/resource.axd</code></td>
</tr>
<tr>
<td>Rearrange URL segments</td>
<td style="text-align:center"><code>path/(.*)/(.*)/(.*)</code><br><code>path/1/2/3</code></td>
<td style="text-align:center"><code>path/$3/$2/$1</code><br><code>path/3/2/1</code></td>
</tr>
<tr>
<td>Replace a URL segment</td>
<td style="text-align:center"><code>^(.*)/segment2/(.*)</code><br><code>/segment1/segment2/segment3</code></td>
<td style="text-align:center"><code>$1/replaced/$2</code><br><code>/segment1/replaced/segment3</code></td>
</tr>
</tbody>
</table>
<h2 id="resources">Resources</h2>
<ul>
<li><a href="startup.html">Application Startup</a></li>
<li><a href="middleware.html">Middleware</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/articles/standard/base-types/regular-expressions">Regular expressions in .NET</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/articles/standard/base-types/quick-ref">Regular expression language - quick reference</a></li>
<li><a href="https://httpd.apache.org/docs/2.4/rewrite/">Apache mod_rewrite</a></li>
<li><a href="https://www.iis.net/learn/extensions/url-rewrite-module/using-url-rewrite-module-20">Using Url Rewrite Module 2.0 (for IIS)</a></li>
<li><a href="https://www.iis.net/learn/extensions/url-rewrite-module/url-rewrite-module-configuration-reference">URL Rewrite Module Configuration Reference</a></li>
<li><a href="https://forums.iis.net/1152.aspx">IIS URL Rewrite Module Forum</a></li>
<li><a href="https://support.google.com/webmasters/answer/76329?hl=en">Keep a simple URL structure</a></li>
<li><a href="http://ruslany.net/2009/04/10-url-rewriting-tips-and-tricks/">10 URL Rewriting Tips and Tricks</a></li>
<li><a href="https://webmasters.googleblog.com/2010/04/to-slash-or-not-to-slash.html">To slash or not to slash</a></li>
</ul>
</article>
          </div>
          <div class="col-md-10">
                    <a name="cloudcomment">
                        <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
                    </a>          
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/dotnetcore/aspnetcore-doc-cn/blob/master/aspnetcore/fundamentals/url-rewriting.md/#L1" class="contribution-link">&#25913;&#36827;&#25991;&#26723;</a>
                  </li>
                                                  <li>
                                              <span style="margin-left: 10px; margin-top: 3px; margin-bottom: 3px;" class="contribution-link"><a class="cloud-tie-join-count" href="#cloudcomment">
                                                  <span class="icon-comment"></span>
                                                  <span class="join-count">0</span>
                                                  <span class="join-text">评论</span>
                                              </a></span>
                                          </li>
                                          <li>
                                              <div style="margin-left: 10px; margin-top: 3px; margin-bottom: 3px;" class="bdsharebuttonbox">
                                                  <a href="#" class="bds_more" data-cmd="more"></a>
                                                  <a href="#" class="bds_mshare" data-cmd="mshare" title="分享到一键分享"></a>
                                                  <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
                                                  <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
                                                  <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
                                                  <a href="#" class="bds_copy" data-cmd="copy" title="分享到复制网址"></a>
                                                  <a href="#" class="bds_print" data-cmd="print" title="分享到打印"></a>
                                              </div>
                                          </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">返回顶部</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">返回顶部</a>
            </span>
            
            <span>Copyright © 2015-2017 Microsoft<br>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
      <script>
      (function(){
          var bp = document.createElement('script');
          var curProtocol = window.location.protocol.split(':')[0];
          if (curProtocol === 'https'){
         bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else{
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(bp, s);
      })();
      </script>    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
    
    <script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>
    <script>
     
        var url = window.location.href;
        
        url = url.replace(window.location.hash,"");
        url = url.replace(window.location.search, "");
    
        var cloudTieConfig = {
            url: url, 
            sourceId: "",
            productKey: "1f2ab3895f9d44a0b3b90ab7a8c4e01b",
            target: "cloud-tie-wrapper"
        };
        var yunManualLoad = true;
        Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);
    </script>
    <script type="text/javascript">window._bd_share_config = { "common": { "bdSnsKey": {}, "bdText": "", "bdMini": "2", "bdMiniList": false, "bdPic": "", "bdStyle": "0", "bdSize": "16" }, "share": {} }; with (document) 0[(getElementsByTagName('head')[0] || body).appendChild(createElement('script')).src = 'http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion=' + ~(-new Date() / 36e5)];</script>
  </body>
</html>
